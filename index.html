<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FlashCast v10 (å®‰å…¨æ¨¡å¼)</title>
    
    <!-- 1. å¢åŠ å…¨å±€é”™è¯¯æ•è·ï¼Œç›´æ¥æ˜¾ç¤ºåœ¨å±å¹•ä¸Š -->
    <script>
        window.onerror = function(msg, url, line, col, error) {
            const log = document.getElementById('debug-log');
            if(log) {
                log.innerHTML += `<div style="color:red; border-bottom:1px solid #333; padding:4px;">âŒ ${msg} (Line:${line})</div>`;
                log.classList.remove('hidden');
            }
            return false;
        };
        // æ•è·æœªå¤„ç†çš„ Promise é”™è¯¯
        window.addEventListener('unhandledrejection', function(event) {
            const log = document.getElementById('debug-log');
            if(log) {
                log.innerHTML += `<div style="color:orange; border-bottom:1px solid #333; padding:4px;">âš ï¸ ${event.reason}</div>`;
                log.classList.remove('hidden');
            }
        });
    </script>

    <!-- 2. æ ¸å¿ƒåº“ (å›½å†…æº) -->
    <script src="https://cdn.staticfile.net/mqtt/4.3.7/mqtt.min.js"></script>
    <script src="https://cdn.staticfile.net/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #f8fafc; --blue: #3b82f6; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow: hidden; height: 100vh; display: flex; flex-direction: column; }
        
        .container { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .hidden { display: none !important; }
        
        h1 { font-size: 32px; margin-bottom: 10px; color: var(--blue); }
        p { color: #94a3b8; margin-bottom: 20px; font-size: 14px; }

        /* å¤§æŒ‰é’® */
        .big-btn {
            background: var(--card);
            border: 1px solid #334155;
            color: white;
            padding: 20px;
            margin: 10px;
            border-radius: 12px;
            width: 100%;
            max-width: 300px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
        }
        .big-btn:active { background: #334155; }

        /* è¿æ¥çŠ¶æ€æ¡ */
        .status-bar {
            background: #334155; padding: 10px; width: 100%; text-align: center; font-size: 12px;
            display: flex; justify-content: center; gap: 10px;
        }
        .status-light { width: 10px; height: 10px; border-radius: 50%; background: #ef4444; }
        .status-light.green { background: #22c55e; box-shadow: 0 0 8px #22c55e; }
        .status-light.yellow { background: #eab308; animation: pulse 1s infinite; }
        @keyframes pulse { 50% { opacity: 0.5; } }

        /* è°ƒè¯•æ—¥å¿—åŒº (å±å¹•åº•éƒ¨) */
        #debug-log {
            position: fixed; bottom: 0; left: 0; right: 0;
            height: 120px; background: rgba(0,0,0,0.9);
            color: #fff; font-family: monospace; font-size: 10px;
            overflow-y: auto; padding: 10px; z-index: 9999;
            text-align: left; border-top: 1px solid #444;
        }

        /* è§†é¢‘å®¹å™¨ */
        video { width: 100%; height: 100%; object-fit: contain; background: black; }
        .video-box { position: fixed; inset: 0; background: black; z-index: 100; display: flex; flex-direction: column; }
        .close-btn { position: absolute; top: 20px; left: 20px; z-index: 101; background: rgba(255,255,255,0.2); border: none; color: white; padding: 8px 15px; border-radius: 20px; }

        input { padding: 15px; border-radius: 8px; border: none; background: #334155; color: white; font-size: 20px; text-align: center; width: 200px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <!-- é¡¶éƒ¨çŠ¶æ€ -->
    <div class="status-bar">
        <div id="light" class="status-light"></div>
        <span id="status-text">æœªè¿æ¥æœåŠ¡å™¨</span>
    </div>

    <!-- é¦–é¡µ (æœªè¿æ¥çŠ¶æ€) -->
    <div id="page-home" class="container">
        <h1>FlashCast v10</h1>
        <p>å®‰å…¨æ¨¡å¼ï¼šè¯·æ‰‹åŠ¨ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®è¿æ¥</p>
        
        <button onclick="connectSystem()" class="big-btn" style="background: var(--blue); font-weight: bold;">
            ğŸš€ ç‚¹å‡»å¼€å§‹è¿æ¥
        </button>

        <div style="margin-top: 30px; font-size: 12px; color: #64748b; text-align: left; background: #1e293b; padding: 15px; border-radius: 8px;">
            <b>æ‰‹æœºæ‰“ä¸å¼€ï¼Ÿè§£å†³æ–¹æ¡ˆï¼š</b><br>
            1. ç¡®ä¿æ‰‹æœºå’Œç”µè„‘è¿çš„æ˜¯<b>åŒä¸€ä¸ª Wi-Fi</b><br>
            2. å¦‚æœæ˜¯ç”¨å¾®ä¿¡æ‰«ç ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’<b>â€œåœ¨æµè§ˆå™¨æ‰“å¼€â€</b><br>
            3. å¦‚æœè¿˜ä¸è¡Œï¼Œè¯·æŠŠç”µè„‘ä¸Šçš„ VPN å…³æ‰ï¼Œæˆ–è€…ç»™æ‰‹æœºä¹Ÿå¼€ VPN
        </div>
    </div>

    <!-- åŠŸèƒ½é€‰æ‹©é¡µ (è¿æ¥æˆåŠŸåæ˜¾ç¤º) -->
    <div id="page-menu" class="container hidden">
        <h1>é€‰æ‹©æ¨¡å¼</h1>
        <p id="conn-msg" style="color: #22c55e;">æœåŠ¡å™¨å·²è¿æ¥</p>
        
        <button onclick="showReceiver()" class="big-btn">ğŸ–¥ï¸ æˆ‘æ˜¯ç”µè„‘ (æ¥æ”¶)</button>
        <button onclick="showSender()" class="big-btn">ğŸ“± æˆ‘æ˜¯æ‰‹æœº (å‘é€)</button>
    </div>

    <!-- æ¥æ”¶ç«¯ -->
    <div id="page-receiver" class="container hidden">
        <button onclick="location.reload()" class="close-btn" style="position:relative; left:0; top:0; margin-bottom:20px;">â¬… è¿”å›</button>
        <div id="qr-area" style="background:white; padding:10px; border-radius:10px;"></div>
        <h2 id="room-code" style="font-size:40px; margin:20px 0; letter-spacing:5px;">...</h2>
        <p>è¯·ç”¨æ‰‹æœºæ‰«æä¸Šæ–¹äºŒç»´ç </p>
    </div>

    <!-- å‘é€ç«¯ -->
    <div id="page-sender" class="container hidden">
        <button onclick="location.reload()" class="close-btn" style="position:relative; left:0; top:0; margin-bottom:20px;">â¬… è¿”å›</button>
        <p>è¾“å…¥ç”µè„‘ä¸Šæ˜¾ç¤ºçš„6ä½æ•°å­—</p>
        <input type="number" id="room-input" placeholder="000000">
        <button onclick="startSharing('screen')" class="big-btn" style="background:var(--blue)">ğŸ“¡ å¼€å§‹æŠ•å±</button>
        <p id="sender-log" style="height:20px; color:orange;"></p>
    </div>

    <!-- è§†é¢‘æµç•Œé¢ -->
    <div id="page-video" class="video-box hidden">
        <button onclick="location.reload()" class="close-btn">âŒ ç»“æŸ</button>
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline style="position:absolute; bottom:20px; right:20px; width:120px; height:180px; border:2px solid white; object-fit:cover; display:none;"></video>
    </div>

    <!-- è°ƒè¯•æ—¥å¿— (é»˜è®¤éšè—ï¼Œæœ‰é”™è¯¯è‡ªåŠ¨æ˜¾ç¤º) -->
    <div id="debug-log" class="hidden">
        <div style="color:#aaa; border-bottom:1px solid #555;">è°ƒè¯•æ—¥å¿— (å‡ºé”™æ—¶æˆªå›¾ç»™æˆ‘)</div>
    </div>

    <script>
        // --- æ ¸å¿ƒé€»è¾‘ ---
        const appPrefix = "fc_v10_safe_";
        let client = null;
        let peerConnection = null;
        let localStream = null;
        
        // çº¿è·¯åˆ—è¡¨ (åŒ…å« websocket å’Œ mqtt åè®®)
        const brokers = [
            'wss://broker.emqx.io:8084/mqtt',
            'wss://broker.hivemq.com:8000/mqtt',
            'wss://test.mosquitto.org:8081/mqtt'
        ];
        let brokerIdx = 0;

        function log(msg) {
            const el = document.getElementById('debug-log');
            if(el) {
                el.classList.remove('hidden');
                el.innerHTML += `<div>${new Date().toLocaleTimeString()} ${msg}</div>`;
                el.scrollTop = el.scrollHeight; // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
            }
            console.log(msg);
        }

        function setStatus(color, text) {
            document.getElementById('light').className = `status-light ${color}`;
            document.getElementById('status-text').innerText = text;
        }

        // 1. æ‰‹åŠ¨ç‚¹å‡»è¿æ¥ (é˜²æ­¢è‡ªåŠ¨åŠ è½½å´©æºƒ)
        function connectSystem() {
            setStatus('yellow', 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...');
            log("å¼€å§‹è¿æ¥ MQTT...");
            tryConnect(0);
        }

        function tryConnect(idx) {
            if(idx >= brokers.length) {
                setStatus('red', 'è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•');
                log("âŒ æ‰€æœ‰çº¿è·¯éƒ½è¿ä¸ä¸Šï¼Œå¯èƒ½æ˜¯åŸŸåè¢«æ‹¦æˆªã€‚");
                alert("æ— æ³•è¿æ¥æœåŠ¡å™¨ã€‚å¦‚æœæ˜¯åœ¨æ‰‹æœºä¸Šï¼Œè¯·å°è¯•åˆ‡æ¢ Wi-Fi æˆ–å…³é—­ VPNã€‚");
                return;
            }

            const url = brokers[idx];
            log(`å°è¯•çº¿è·¯ ${idx + 1}: ${url}`);

            try {
                // ç”ŸæˆéšæœºID
                const clientId = 'user_' + Math.random().toString(16).substr(2, 6);
                
                client = mqtt.connect(url, {
                    clientId: clientId,
                    connectTimeout: 5000,
                    keepalive: 60
                });

                client.on('connect', () => {
                    log("âœ… è¿æ¥æˆåŠŸ!");
                    setStatus('green', 'æœåŠ¡å™¨å·²è¿æ¥');
                    
                    // è¿æ¥æˆåŠŸåï¼Œæ£€æŸ¥ URL æ˜¯å¦å¸¦æœ‰æˆ¿é—´å·
                    const params = new URLSearchParams(window.location.search);
                    const room = params.get('roomId');
                    
                    document.getElementById('page-home').classList.add('hidden');
                    if (room) {
                        document.getElementById('room-input').value = room;
                        document.getElementById('page-sender').classList.remove('hidden');
                    } else {
                        document.getElementById('page-menu').classList.remove('hidden');
                    }
                });

                client.on('error', (err) => {
                    log(`âš ï¸ çº¿è·¯ ${idx+1} é”™è¯¯: ${err.message}`);
                    client.end();
                    setTimeout(() => tryConnect(idx + 1), 500);
                });
                
                // è®¾ç½®è¶…æ—¶ä¿é™©
                setTimeout(() => {
                    if(!client.connected) {
                        log(`â³ çº¿è·¯ ${idx+1} è¶…æ—¶`);
                        try { client.end(); } catch(e){}
                        tryConnect(idx + 1);
                    }
                }, 6000);

            } catch (e) {
                log(`âŒ è‡´å‘½é”™è¯¯: ${e.message}`);
            }
        }

        // --- ç•Œé¢åˆ‡æ¢ ---
        window.showReceiver = () => {
            document.getElementById('page-menu').classList.add('hidden');
            document.getElementById('page-receiver').classList.remove('hidden');
            startReceiverLogic();
        };

        window.showSender = () => {
            document.getElementById('page-menu').classList.add('hidden');
            document.getElementById('page-sender').classList.remove('hidden');
        };

        // --- WebRTC é€»è¾‘ ---
        const rtcConfig = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

        async function startReceiverLogic() {
            const roomId = Math.floor(100000 + Math.random() * 900000);
            document.getElementById('room-code').innerText = roomId;
            
            // ç”ŸæˆäºŒç»´ç 
            document.getElementById('qr-area').innerHTML = '';
            // å»æ‰ URL å‚æ•°ï¼Œåªä¿ç•™çº¯å‡€é“¾æ¥
            const cleanUrl = window.location.href.split('?')[0] + '?roomId=' + roomId;
            log(`ç”Ÿæˆè¿æ¥: ${cleanUrl}`);
            
            new QRCode(document.getElementById("qr-area"), {
                text: cleanUrl,
                width: 200, height: 200
            });

            const topic = `${appPrefix}${roomId}/#`;
            client.subscribe(topic);
            log(`ç­‰å¾…è®¢é˜…: ${topic}`);

            peerConnection = new RTCPeerConnection(rtcConfig);
            
            peerConnection.ontrack = (event) => {
                log("æ”¶åˆ°è§†é¢‘æµ!");
                document.getElementById('page-receiver').classList.add('hidden');
                document.getElementById('page-video').classList.remove('hidden');
                document.getElementById('remote-video').srcObject = event.streams[0];
            };

            peerConnection.onicecandidate = e => {
                if (e.candidate) client.publish(`${appPrefix}${roomId}/ice_r`, JSON.stringify(e.candidate));
            };

            client.on('message', async (t, m) => {
                if(t.includes('/offer')) {
                    log("æ”¶åˆ°æŠ•å±è¯·æ±‚");
                    const offer = JSON.parse(m.toString());
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await peerConnection.createAnswer();
                    await peerConnection.setLocalDescription(answer);
                    client.publish(`${appPrefix}${roomId}/answer`, JSON.stringify(answer));
                }
                if(t.includes('/ice_s')) {
                    try { await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(m.toString()))); } catch(e){}
                }
            });
        }

        async function startSharing() {
            const roomId = document.getElementById('room-input').value;
            if(!roomId) return alert("è¯·è¾“å…¥æˆ¿é—´å·");
            
            const logEl = document.getElementById('sender-log');
            logEl.innerText = "æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´/å±å¹•æƒé™...";
            
            try {
                // ä¼˜å…ˆå°è¯•å±å¹•å…±äº«ï¼Œæ‰‹æœºå¯èƒ½ä¸æ”¯æŒï¼Œåˆ™å›é€€æˆ–æŠ¥é”™
                if (navigator.mediaDevices && navigator.mediaDevices.getDisplayMedia) {
                    localStream = await navigator.mediaDevices.getDisplayMedia({video:true, audio:true});
                } else {
                    alert("æ‰‹æœºæµè§ˆå™¨é€šå¸¸ä¸æ”¯æŒã€å±å¹•ã€‘å…±äº«ï¼Œå³å°†å°è¯•ã€æ‘„åƒå¤´ã€‘å…±äº«ã€‚");
                    localStream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:true});
                }
            } catch(e) {
                logEl.innerText = "æƒé™è·å–å¤±è´¥: " + e.message;
                log("æƒé™é”™è¯¯: " + e.message);
                return;
            }

            document.getElementById('page-sender').classList.add('hidden');
            document.getElementById('page-video').classList.remove('hidden');
            const localVid = document.getElementById('local-video');
            localVid.style.display = 'block';
            localVid.srcObject = localStream;

            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));

            peerConnection.onicecandidate = e => {
                if(e.candidate) client.publish(`${appPrefix}${roomId}/ice_s`, JSON.stringify(e.candidate));
            };
            
            client.subscribe(`${appPrefix}${roomId}/answer`);
            client.subscribe(`${appPrefix}${roomId}/ice_r`);

            client.on('message', async (t, m) => {
                if(t.includes('/answer')) {
                    log("å¯¹æ–¹å·²æ¥å—è¿æ¥");
                    await peerConnection.setRemoteDescription(new RTCSessionDescription(JSON.parse(m.toString())));
                }
                if(t.includes('/ice_r')) {
                    try { await peerConnection.addIceCandidate(new RTCIceCandidate(JSON.parse(m.toString()))); } catch(e){}
                }
            });

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);
            client.publish(`${appPrefix}${roomId}/offer`, JSON.stringify(offer));
            log("å·²å‘é€æŠ•å±è¯·æ±‚...");
        }
    </script>
</body>
</html>